{"version":3,"file":"xtb.js","sourceRoot":"","sources":["../../../../../../../packages/compiler/src/i18n/serializers/xtb.ts"],"names":[],"mappings":";;;;;;;;;;;;AAQA,OAAO,KAAK,EAAE,MAAM,qBAAqB,CAAC;AAC1C,OAAO,EAAC,SAAS,EAAC,MAAM,4BAA4B,CAAC;AACrD,OAAO,KAAK,IAAI,MAAM,aAAa,CAAC;AACpC,OAAO,EAAC,SAAS,EAAC,MAAM,eAAe,CAAC;AAExC,OAAO,EAAoB,UAAU,EAAE,uBAAuB,EAAC,MAAM,cAAc,CAAC;AACpF,OAAO,EAAC,MAAM,EAAE,YAAY,EAAC,MAAM,OAAO,CAAC;AAE3C,qBAAM,iBAAiB,GAAG,mBAAmB,CAAC;AAC9C,qBAAM,gBAAgB,GAAG,aAAa,CAAC;AACvC,qBAAM,gBAAgB,GAAG,IAAI,CAAC;AAE9B,IAAA;IAAyB,+BAAU;;;;;;;;;IACjC,mBAAK;;;;;IAAL,UAAM,QAAwB,EAAE,MAAmB,IAAY,MAAM,IAAI,KAAK,CAAC,aAAa,CAAC,CAAC,EAAE;;;;;;IAEhG,kBAAI;;;;;IAAJ,UAAK,OAAe,EAAE,GAAW;;QAG/B,qBAAM,SAAS,GAAG,IAAI,SAAS,EAAE,CAAC;QAClC,wCAAO,kBAAM,EAAE,4BAAW,EAAE,kBAAM,CAAkC;;QAGpE,qBAAM,gBAAgB,GAAmC,EAAE,CAAC;QAC5D,qBAAM,SAAS,GAAG,IAAI,SAAS,EAAE,CAAC;;;;QAKlC,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC,OAAO,CAAC,UAAA,KAAK;YACpC,qBAAM,OAAO,GAAG;gBACd,qDAAO,wBAAS,EAAE,kBAAM,CAA+C;gBACvE,EAAE,CAAC,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC;oBAClB,MAAM,IAAI,KAAK,CAAC,wBAAsB,MAAM,CAAC,IAAI,CAAC,IAAI,CAAG,CAAC,CAAC;iBAC5D;gBACD,MAAM,CAAC,SAAS,CAAC;aAClB,CAAC;YACF,kBAAkB,CAAC,gBAAgB,EAAE,KAAK,EAAE,OAAO,CAAC,CAAC;SACtD,CAAC,CAAC;QAEH,EAAE,CAAC,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC;YAClB,MAAM,IAAI,KAAK,CAAC,wBAAsB,MAAM,CAAC,IAAI,CAAC,IAAI,CAAG,CAAC,CAAC;SAC5D;QAED,MAAM,CAAC,EAAC,MAAM,qBAAE,MAAM,EAAE,EAAE,gBAAgB,kBAAA,EAAC,CAAC;KAC7C;;;;;IAED,oBAAM;;;;IAAN,UAAO,OAAqB,IAAY,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,EAAE;;;;;IAEjE,8BAAgB;;;;IAAhB,UAAiB,OAAqB;QACpC,MAAM,CAAC,IAAI,uBAAuB,CAAC,OAAO,EAAE,YAAY,CAAC,CAAC;KAC3D;cA1DH;EAoByB,UAAU,EAuClC,CAAA;AAvCD,eAuCC;;;;;;;AAED,4BAA4B,QAAa,EAAE,EAAU,EAAE,OAAkB;IACvE,MAAM,CAAC,cAAc,CAAC,QAAQ,EAAE,EAAE,EAAE;QAClC,YAAY,EAAE,IAAI;QAClB,UAAU,EAAE,IAAI;QAChB,GAAG,EAAE;YACH,qBAAM,KAAK,GAAG,OAAO,EAAE,CAAC;YACxB,MAAM,CAAC,cAAc,CAAC,QAAQ,EAAE,EAAE,EAAE,EAAC,UAAU,EAAE,IAAI,EAAE,KAAK,OAAA,EAAC,CAAC,CAAC;YAC/D,MAAM,CAAC,KAAK,CAAC;SACd;QACD,GAAG,EAAE,UAAA,CAAC,IAAM,MAAM,IAAI,KAAK,CAAC,wCAAwC,CAAC,CAAC,EAAE;KACzE,CAAC,CAAC;CACJ;AAGD,IAAA;;uBAIiC,IAAI;;;;;;;IAEnC,yBAAK;;;;;IAAL,UAAM,GAAW,EAAE,GAAW;QAC5B,IAAI,CAAC,YAAY,GAAG,CAAC,CAAC;QACtB,IAAI,CAAC,YAAY,GAAG,EAAE,CAAC;;;QAIvB,qBAAM,GAAG,GAAG,IAAI,SAAS,EAAE,CAAC,KAAK,CAAC,GAAG,EAAE,GAAG,EAAE,KAAK,CAAC,CAAC;QAEnD,IAAI,CAAC,OAAO,GAAG,GAAG,CAAC,MAAM,CAAC;QAC1B,EAAE,CAAC,QAAQ,CAAC,IAAI,EAAE,GAAG,CAAC,SAAS,CAAC,CAAC;QAEjC,MAAM,CAAC;YACL,WAAW,EAAE,IAAI,CAAC,YAAY;YAC9B,MAAM,EAAE,IAAI,CAAC,OAAO;YACpB,MAAM,EAAE,IAAI,CAAC,OAAO;SACrB,CAAC;KACH;;;;;;IAED,gCAAY;;;;;IAAZ,UAAa,OAAmB,EAAE,OAAY;QAC5C,MAAM,CAAC,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC;YACrB,KAAK,iBAAiB;gBACpB,IAAI,CAAC,YAAY,EAAE,CAAC;gBACpB,EAAE,CAAC,CAAC,IAAI,CAAC,YAAY,GAAG,CAAC,CAAC,CAAC,CAAC;oBAC1B,IAAI,CAAC,SAAS,CAAC,OAAO,EAAE,MAAI,iBAAiB,iCAA8B,CAAC,CAAC;iBAC9E;gBACD,qBAAM,QAAQ,GAAG,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,UAAC,IAAI,IAAK,OAAA,IAAI,CAAC,IAAI,KAAK,MAAM,EAApB,CAAoB,CAAC,CAAC;gBACpE,EAAE,CAAC,CAAC,QAAQ,CAAC,CAAC,CAAC;oBACb,IAAI,CAAC,OAAO,GAAG,QAAQ,CAAC,KAAK,CAAC;iBAC/B;gBACD,EAAE,CAAC,QAAQ,CAAC,IAAI,EAAE,OAAO,CAAC,QAAQ,EAAE,IAAI,CAAC,CAAC;gBAC1C,IAAI,CAAC,YAAY,EAAE,CAAC;gBACpB,KAAK,CAAC;YAER,KAAK,gBAAgB;gBACnB,qBAAM,MAAM,GAAG,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,UAAC,IAAI,IAAK,OAAA,IAAI,CAAC,IAAI,KAAK,IAAI,EAAlB,CAAkB,CAAC,CAAC;gBAChE,EAAE,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC;oBACZ,IAAI,CAAC,SAAS,CAAC,OAAO,EAAE,MAAI,gBAAgB,kCAA6B,CAAC,CAAC;iBAC5E;gBAAC,IAAI,CAAC,CAAC;oBACN,qBAAM,EAAE,GAAG,MAAM,CAAC,KAAK,CAAC;oBACxB,EAAE,CAAC,CAAC,IAAI,CAAC,YAAY,CAAC,cAAc,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC;wBACzC,IAAI,CAAC,SAAS,CAAC,OAAO,EAAE,qCAAmC,EAAI,CAAC,CAAC;qBAClE;oBAAC,IAAI,CAAC,CAAC;wBACN,qBAAM,cAAc,sBAAG,OAAO,CAAC,eAAe,GAAG,GAAG,CAAC,MAAM,CAAC;wBAC5D,qBAAM,YAAY,sBAAG,OAAO,CAAC,aAAa,GAAG,KAAK,CAAC,MAAM,CAAC;wBAC1D,qBAAM,OAAO,sBAAG,OAAO,CAAC,eAAe,GAAG,KAAK,CAAC,IAAI,CAAC,OAAO,CAAC;wBAC7D,qBAAM,SAAS,GAAG,OAAO,CAAC,KAAK,oBAAC,cAAc,uBAAI,YAAY,GAAG,CAAC;wBAClE,IAAI,CAAC,YAAY,CAAC,EAAE,CAAC,GAAG,SAAS,CAAC;qBACnC;iBACF;gBACD,KAAK,CAAC;YAER;gBACE,IAAI,CAAC,SAAS,CAAC,OAAO,EAAE,gBAAgB,CAAC,CAAC;SAC7C;KACF;;;;;;IAED,kCAAc;;;;;IAAd,UAAe,SAAuB,EAAE,OAAY,KAAS;;;;;;IAE7D,6BAAS;;;;;IAAT,UAAU,IAAa,EAAE,OAAY,KAAS;;;;;;IAE9C,gCAAY;;;;;IAAZ,UAAa,OAAmB,EAAE,OAAY,KAAS;;;;;;IAEvD,kCAAc;;;;;IAAd,UAAe,SAAuB,EAAE,OAAY,KAAS;;;;;;IAE7D,sCAAkB;;;;;IAAlB,UAAmB,aAA+B,EAAE,OAAY,KAAS;;;;;;IAEjE,6BAAS;;;;;cAAC,IAAa,EAAE,OAAe;QAC9C,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,SAAS,oBAAC,IAAI,CAAC,UAAU,IAAI,OAAO,CAAC,CAAC,CAAC;;oBApJjE;IAsJC,CAAA;;;;;;;;;;;AAGD,IAAA;;;;;;;;IAGE,2BAAO;;;;;IAAP,UAAQ,OAAe,EAAE,GAAW;QAClC,qBAAM,MAAM,GAAG,IAAI,SAAS,EAAE,CAAC,KAAK,CAAC,OAAO,EAAE,GAAG,EAAE,IAAI,CAAC,CAAC;QACzD,IAAI,CAAC,OAAO,GAAG,MAAM,CAAC,MAAM,CAAC;QAE7B,qBAAM,SAAS,GAAG,IAAI,CAAC,OAAO,CAAC,MAAM,GAAG,CAAC,IAAI,MAAM,CAAC,SAAS,CAAC,MAAM,IAAI,CAAC,CAAC,CAAC;YACvE,EAAE,CAAC,CAAC;YACJ,EAAE,CAAC,QAAQ,CAAC,IAAI,EAAE,MAAM,CAAC,SAAS,CAAC,CAAC;QAExC,MAAM,CAAC;YACL,SAAS,WAAA;YACT,MAAM,EAAE,IAAI,CAAC,OAAO;SACrB,CAAC;KACH;;;;;;IAED,6BAAS;;;;;IAAT,UAAU,IAAa,EAAE,OAAY,IAAI,MAAM,CAAC,IAAI,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,KAAK,qBAAE,IAAI,CAAC,UAAU,GAAG,CAAC,EAAE;;;;;;IAE/F,kCAAc;;;;;IAAd,UAAe,GAAiB,EAAE,OAAY;QAC5C,qBAAM,OAAO,GAAiC,EAAE,CAAC;QAEjD,EAAE,CAAC,QAAQ,CAAC,IAAI,EAAE,GAAG,CAAC,KAAK,CAAC,CAAC,OAAO,CAAC,UAAA,CAAC;YACpC,OAAO,CAAC,CAAC,CAAC,KAAK,CAAC,GAAG,IAAI,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,KAAK,EAAE,GAAG,CAAC,UAAU,CAAC,CAAC;SAChE,CAAC,CAAC;QAEH,MAAM,CAAC,IAAI,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,WAAW,EAAE,GAAG,CAAC,IAAI,EAAE,OAAO,EAAE,GAAG,CAAC,UAAU,CAAC,CAAC;KACzE;;;;;;IAED,sCAAkB;;;;;IAAlB,UAAmB,OAAyB,EAAE,OAAY;QACxD,MAAM,CAAC;YACL,KAAK,EAAE,OAAO,CAAC,KAAK;YACpB,KAAK,EAAE,EAAE,CAAC,QAAQ,CAAC,IAAI,EAAE,OAAO,CAAC,UAAU,CAAC;SAC7C,CAAC;KACH;;;;;;IAED,gCAAY;;;;;IAAZ,UAAa,EAAc,EAAE,OAAY;QACvC,EAAE,CAAC,CAAC,EAAE,CAAC,IAAI,KAAK,gBAAgB,CAAC,CAAC,CAAC;YACjC,qBAAM,QAAQ,GAAG,EAAE,CAAC,KAAK,CAAC,IAAI,CAAC,UAAC,IAAI,IAAK,OAAA,IAAI,CAAC,IAAI,KAAK,MAAM,EAApB,CAAoB,CAAC,CAAC;YAC/D,EAAE,CAAC,CAAC,QAAQ,CAAC,CAAC,CAAC;gBACb,MAAM,CAAC,IAAI,IAAI,CAAC,WAAW,CAAC,EAAE,EAAE,QAAQ,CAAC,KAAK,qBAAE,EAAE,CAAC,UAAU,GAAG,CAAC;aAClE;YAED,IAAI,CAAC,SAAS,CAAC,EAAE,EAAE,MAAI,gBAAgB,oCAA+B,CAAC,CAAC;SACzE;QAAC,IAAI,CAAC,CAAC;YACN,IAAI,CAAC,SAAS,CAAC,EAAE,EAAE,gBAAgB,CAAC,CAAC;SACtC;QACD,MAAM,CAAC,IAAI,CAAC;KACb;;;;;;IAED,gCAAY;;;;;IAAZ,UAAa,OAAmB,EAAE,OAAY,KAAI;;;;;;IAElD,kCAAc;;;;;IAAd,UAAe,SAAuB,EAAE,OAAY,KAAI;;;;;;IAEhD,6BAAS;;;;;cAAC,IAAa,EAAE,OAAe;QAC9C,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,SAAS,oBAAC,IAAI,CAAC,UAAU,IAAI,OAAO,CAAC,CAAC,CAAC;;oBAhNjE;IAkNC,CAAA","sourcesContent":["/**\n * @license\n * Copyright Google Inc. All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\nimport * as ml from '../../ml_parser/ast';\nimport {XmlParser} from '../../ml_parser/xml_parser';\nimport * as i18n from '../i18n_ast';\nimport {I18nError} from '../parse_util';\n\nimport {PlaceholderMapper, Serializer, SimplePlaceholderMapper} from './serializer';\nimport {digest, toPublicName} from './xmb';\n\nconst _TRANSLATIONS_TAG = 'translationbundle';\nconst _TRANSLATION_TAG = 'translation';\nconst _PLACEHOLDER_TAG = 'ph';\n\nexport class Xtb extends Serializer {\n  write(messages: i18n.Message[], locale: string|null): string { throw new Error('Unsupported'); }\n\n  load(content: string, url: string):\n      {locale: string, i18nNodesByMsgId: {[msgId: string]: i18n.Node[]}} {\n    // xtb to xml nodes\n    const xtbParser = new XtbParser();\n    const {locale, msgIdToHtml, errors} = xtbParser.parse(content, url);\n\n    // xml nodes to i18n nodes\n    const i18nNodesByMsgId: {[msgId: string]: i18n.Node[]} = {};\n    const converter = new XmlToI18n();\n\n    // Because we should be able to load xtb files that rely on features not supported by angular,\n    // we need to delay the conversion of html to i18n nodes so that non angular messages are not\n    // converted\n    Object.keys(msgIdToHtml).forEach(msgId => {\n      const valueFn = function() {\n        const {i18nNodes, errors} = converter.convert(msgIdToHtml[msgId], url);\n        if (errors.length) {\n          throw new Error(`xtb parse errors:\\n${errors.join('\\n')}`);\n        }\n        return i18nNodes;\n      };\n      createLazyProperty(i18nNodesByMsgId, msgId, valueFn);\n    });\n\n    if (errors.length) {\n      throw new Error(`xtb parse errors:\\n${errors.join('\\n')}`);\n    }\n\n    return {locale: locale !, i18nNodesByMsgId};\n  }\n\n  digest(message: i18n.Message): string { return digest(message); }\n\n  createNameMapper(message: i18n.Message): PlaceholderMapper {\n    return new SimplePlaceholderMapper(message, toPublicName);\n  }\n}\n\nfunction createLazyProperty(messages: any, id: string, valueFn: () => any) {\n  Object.defineProperty(messages, id, {\n    configurable: true,\n    enumerable: true,\n    get: function() {\n      const value = valueFn();\n      Object.defineProperty(messages, id, {enumerable: true, value});\n      return value;\n    },\n    set: _ => { throw new Error('Could not overwrite an XTB translation'); },\n  });\n}\n\n// Extract messages as xml nodes from the xtb file\nclass XtbParser implements ml.Visitor {\n  private _bundleDepth: number;\n  private _errors: I18nError[];\n  private _msgIdToHtml: {[msgId: string]: string};\n  private _locale: string|null = null;\n\n  parse(xtb: string, url: string) {\n    this._bundleDepth = 0;\n    this._msgIdToHtml = {};\n\n    // We can not parse the ICU messages at this point as some messages might not originate\n    // from Angular that could not be lex'd.\n    const xml = new XmlParser().parse(xtb, url, false);\n\n    this._errors = xml.errors;\n    ml.visitAll(this, xml.rootNodes);\n\n    return {\n      msgIdToHtml: this._msgIdToHtml,\n      errors: this._errors,\n      locale: this._locale,\n    };\n  }\n\n  visitElement(element: ml.Element, context: any): any {\n    switch (element.name) {\n      case _TRANSLATIONS_TAG:\n        this._bundleDepth++;\n        if (this._bundleDepth > 1) {\n          this._addError(element, `<${_TRANSLATIONS_TAG}> elements can not be nested`);\n        }\n        const langAttr = element.attrs.find((attr) => attr.name === 'lang');\n        if (langAttr) {\n          this._locale = langAttr.value;\n        }\n        ml.visitAll(this, element.children, null);\n        this._bundleDepth--;\n        break;\n\n      case _TRANSLATION_TAG:\n        const idAttr = element.attrs.find((attr) => attr.name === 'id');\n        if (!idAttr) {\n          this._addError(element, `<${_TRANSLATION_TAG}> misses the \"id\" attribute`);\n        } else {\n          const id = idAttr.value;\n          if (this._msgIdToHtml.hasOwnProperty(id)) {\n            this._addError(element, `Duplicated translations for msg ${id}`);\n          } else {\n            const innerTextStart = element.startSourceSpan !.end.offset;\n            const innerTextEnd = element.endSourceSpan !.start.offset;\n            const content = element.startSourceSpan !.start.file.content;\n            const innerText = content.slice(innerTextStart !, innerTextEnd !);\n            this._msgIdToHtml[id] = innerText;\n          }\n        }\n        break;\n\n      default:\n        this._addError(element, 'Unexpected tag');\n    }\n  }\n\n  visitAttribute(attribute: ml.Attribute, context: any): any {}\n\n  visitText(text: ml.Text, context: any): any {}\n\n  visitComment(comment: ml.Comment, context: any): any {}\n\n  visitExpansion(expansion: ml.Expansion, context: any): any {}\n\n  visitExpansionCase(expansionCase: ml.ExpansionCase, context: any): any {}\n\n  private _addError(node: ml.Node, message: string): void {\n    this._errors.push(new I18nError(node.sourceSpan !, message));\n  }\n}\n\n// Convert ml nodes (xtb syntax) to i18n nodes\nclass XmlToI18n implements ml.Visitor {\n  private _errors: I18nError[];\n\n  convert(message: string, url: string) {\n    const xmlIcu = new XmlParser().parse(message, url, true);\n    this._errors = xmlIcu.errors;\n\n    const i18nNodes = this._errors.length > 0 || xmlIcu.rootNodes.length == 0 ?\n        [] :\n        ml.visitAll(this, xmlIcu.rootNodes);\n\n    return {\n      i18nNodes,\n      errors: this._errors,\n    };\n  }\n\n  visitText(text: ml.Text, context: any) { return new i18n.Text(text.value, text.sourceSpan !); }\n\n  visitExpansion(icu: ml.Expansion, context: any) {\n    const caseMap: {[value: string]: i18n.Node} = {};\n\n    ml.visitAll(this, icu.cases).forEach(c => {\n      caseMap[c.value] = new i18n.Container(c.nodes, icu.sourceSpan);\n    });\n\n    return new i18n.Icu(icu.switchValue, icu.type, caseMap, icu.sourceSpan);\n  }\n\n  visitExpansionCase(icuCase: ml.ExpansionCase, context: any): any {\n    return {\n      value: icuCase.value,\n      nodes: ml.visitAll(this, icuCase.expression),\n    };\n  }\n\n  visitElement(el: ml.Element, context: any): i18n.Placeholder|null {\n    if (el.name === _PLACEHOLDER_TAG) {\n      const nameAttr = el.attrs.find((attr) => attr.name === 'name');\n      if (nameAttr) {\n        return new i18n.Placeholder('', nameAttr.value, el.sourceSpan !);\n      }\n\n      this._addError(el, `<${_PLACEHOLDER_TAG}> misses the \"name\" attribute`);\n    } else {\n      this._addError(el, `Unexpected tag`);\n    }\n    return null;\n  }\n\n  visitComment(comment: ml.Comment, context: any) {}\n\n  visitAttribute(attribute: ml.Attribute, context: any) {}\n\n  private _addError(node: ml.Node, message: string): void {\n    this._errors.push(new I18nError(node.sourceSpan !, message));\n  }\n}\n"]}